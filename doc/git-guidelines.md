## 分支（Branches）
- `stable`: 指向经过生产环境测试且可投入生产的最新版本代码。推荐交易所使用此分支。

- `0.0.x`: 当前发布分支，始终指向最新版本。司命和种子节点操作者可运行此分支。若存在不影响交易所的次要错误修复或仅涉及司命的安全修复，`stable` 和 `0.0.x` 可能会分叉。

- `main`: 活跃的开发分支。我们努力确保 `main` 处于可工作状态。所有 PR 在合并前必须通过自动化测试。尽管不能保证 `main` 完全无缺陷，但能确保分支可在标准构建配置下编译并通过现有各套测试。运行 `main` 节点存在风险，建议区块生产节点基于 `stable` 或 `0.0.x` 构建。如需测试新功能，请使用 `main`。

### 发布流程

发布分为主版本和次版本两种流程：

次版本发布：在发布分支（`0.0.x`）上打标签并合并到 `main`，确保所有变更同步至 `main`。

主版本发布：先将发布分支合并到 `main`（以防存在未发布的变更），再从 `main` 创建新发布分支（如`0.1.x`），并在新分支上打标签。

### 补丁分支

所有变更应在独立分支中开发。分支需基于 `main` 或 `0.0.x`，测试完成后合并回原分支。命名规则为：问题编号 + 短描述，例如问题22是“允许撤销祭拜”，那么对应分支 `22-undo-adore`就是用来开发解决这个问题的补丁的。

### 非问题分支

微小变更（如日志调整）可能无需创建问题（issue），但仍需通过分支提交。建议分支命名格式为 `YYYYMMDD-简短描述`（如 `20250913-文档更新`），以便定期清理旧分支。

## 拉取请求（PR）

所有对 `0.0.x` 和 `main` 的变更必须通过 GitHub PR 提交，原因如下：

- 强制两步认证（two factor authentication）：GitHub 仅允许登录后在官方界面合并 PR。
- 强制测试：所有 PR 需通过自动化测试。
- 鼓励最佳实践：开发者需自行充分测试以确保代码正确性。
- 强制代码审查：所有 PR 必须由非作者的其他开发者审核。外部贡献者的 PR 需由两名大傩开发者（如坐忘道、袄景教成员）审核。审核通过后需标记 +1 或明确批准，否则需指出问题以便修改。

为了创建一个文档链，所有的 PR 都应该引用与之相关的问题。

若 PR 存在合并冲突，需将基础分支（如 main）合并到功能分支以本地解决冲突，然后推送更新至原PR。推荐使用merging而非rebase，以免丢失历史记录。

### 社区贡献 PR

社区开发者可提交 PR，但需确保基于的分支正确（`0.0.x` 或 `main`）。若存在冲突或错误合并，PR 将被关闭并要求修复后重新提交。

审核通过后，Taiyi开发者会将社区 PR 合并到以 `问题编号-PR` 命名的本地分支（如 `3412-PR`）。随后创建新 PR，引用原始社区 PR 的讨论内容，并遵循标准审核流程。

社区 PR 需通过相同 CI 测试，若失败则可能被关闭并要求修改。建议社区开发者本地使用 `docker build .`，然后在容器中模拟 CI 环境测试。

## 策略

### 强制推送策略

- 受保护分支（`stable`、`0.0.x`、`main`）禁止强制推送，仅允许在发布时调整提交记录（由 GitHub 分支保护强制执行）。
- 补丁分支可随时强制推送，但需经该补丁的开发者或团队同意。在其他开发者未允许的情况下，不要强制推送他们的分支。

### 打标签策略

- 标签仅用于发布版本，版本格式为 `v主版本.硬分叉.发行版`（如 v0.5.0 对应硬分叉5的发行版）。

### 代码审核与PR合并流程

- *每个变更需由两名开发者审核*后方可合并到 `main` 或 `0.0.x`。即使是微小改动也可能影响共识，需视为潜在破坏性变更。
- 其中一名审核者可以是作者本人。
- 审核需切换至“评审视角”：假设此 PR 来自陌生贡献者，是否能理解其意图？是否引入测试问题或代码风格问题？
- 多人对补丁检查能够降低潜在错误的可能性。
- 社区开发者可参与审核，但其建议非强制要求（但可能帮助发现漏洞）。

## 示例：发布分支的管理

以 `0.1.0` 发布为例，后续版本流程相同（仅分支名不同）：

1. 新功能开发在 `main` 进行。
```
 main
     *
     |
     |
     |
```

2. 发布时从 `main` 创建 `0.1.x` 分支并打标签 `v0.21.0`。
```
 main/v0.1.0
     *
     |
     |
     |
```

3. 后续开发继续在 `main` 进行，`stable` 和 `0.1.x` 指向发布版本。
```
 main
     *
     |
     *  <- 0.1.x (branch), stable (branch), v0.1.0 (tag)
     |
     |
```

4. 若需对 `0.1.0` 打补丁，从 `0.1.x` 创建新标签 `v0.1.1`。
```
 main
     *
     |   *  <- 0.1.x (branch), v0.1.1 (tag)
     |  /
     | /
     *  <- stable (branch), v0.1.0 (tag)
     |
     |
```

5. 将补丁合并回 `main` 以同步修复。
```
 main
     *
     | \
     |  \
     |   *  <- 0.1.x (branch), v0.1.1 (tag)
     |  /
     | /
     *  <- stable (branch), v0.1.0 (tag)
     |
     |
```

6. 重复上述流程，保持分支结构清晰。
```
                   main
     修复合并->     *
                   | \
                   |  \
                   |   \
                   |    \
                   |     \
     修复合并->     |      * <- 0.1.x (branch), v0.1.2 (tag)
                   | \   /
                   |  \ /
                   |   *  <- v0.1.1 (tag)
                   |  /
                   | /
                   *  <- stable (branch), v0.1.0 (tag)
                   |
                   |
```
